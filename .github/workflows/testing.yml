# This is a basic workflow to help you get started with Actions

name: CI-testing

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the jethub-repo branch
  push:
    branches: [ add* ]
  pull_request:
    branches: [ add* ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    strategy:
       board:
          ubuntuver = [ focal hirsuite ]
          kernelver = [ edge current ]
          name = [ jethubj80 jethubj100 ]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Fix Permitions
        run: sudo chown -R actions:actions /home/actions/actions-runner/_work/

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2.3.4

      - name: Set JETHOME_CI_DEBS_DIR variable
        run: |
         echo "JETHOME_CI_DEBS_DIR=testing" >> $GITHUB_ENV; \
         echo "JETHOME_CI_FIRMW_DIR=testing" >> $GITHUB_ENV;

      - name: Copy key
        run: |
         cp /home/actions/exported.key ./
      
      - name: Compile
        run: |
         ./compile.sh docker BOARD=${{ board.name }} LIB_TAG=${GITHUB_REF##*/} GPG_PASS=fakepass CLEAN_LEVEL="make,alldebs,cache" BRANCH=${{ board.kernelver }} RELEASE=${{ board.ubuntuver }} BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_ONLY=no KERNEL_CONFIGURE=no COMPRESS_OUTPUTIMAGE=sha,gpg,img,xz; \

      - name: Upload images
        run: |
         rsync -av output/images/Armbian_*_Jethub-j*_*.img.* repo@update.jethome.ru:/var/www/update.jethome.ru/armbian/$JETHOME_CI_FIRMW_DIR/
         

#!/bin/bash

if [[ -f /root/.not_logged_in_yet && -n $(tty) ]]; then

        echo -e "\nWaiting for system to finish booting ...\n"

        systemctl is-system-running --wait >/dev/null

        echo -e "\nYou are using an Armbian autotest build"
        echo -e "\n This image is provided for start stratup.sh from first usb device"

        trap '' 2

        echo "Checking usb devices for startup.sh ..."
        mountpoint -q /mnt && (umount /mnt && echo umount /mnt || ( echo mnt is already mounted && exit 1))

        echo -e "       /mnt ready for mount"
        for devlink in /dev/disk/by-id/usb*part1; do
            PARTITION=$(readlink -f ${devlink};)
            echo -e "   Found usb flash on $PARTITION (${devlink})"
            mount $PARTITION /mnt
            [ -f /mnt/startup.sh ] && /bin/bash /mnt/startup.sh || echo -e "startup.sh not found on ${devlink}"
            umount -f /mnt
        done

        trap - INT TERM EXIT

        # Display reboot recommendation if necessary
        if [[ -f /var/run/resize2fs-reboot ]]; then
                printf "\n\n\e[0;91mWarning: a reboot is needed to finish resizing the filesystem \x1B[0m \n"
                printf "\e[0;91mPlease reboot the system now \x1B[0m \n\n"
        fi

fi
